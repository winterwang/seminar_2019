---
title: "Understand sensitivity and specificity"
subtitle: "ピロリ菌セミナー"
author: "王　超辰 | Chaochen Wang"
date: "2019-02-13 pm"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      countdown: 60000
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
mono_light(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  # text_font_google   = google_font("M PLUS Rounded 1c", "300", "300i"),
  text_font_google = google_font("Noto Sans JP", "300", "300i"), 
  code_font_google   = google_font("Droid Mono"),
  text_bold_color = "#B03A2E"
)
# write_xaringan_theme(text_bold_color = "#FF4333")
```

class: middle
# 目標 <br> objectives

- 確率論の基本を理解する <br> Understand the basic theories of probability

- 確率ツリーを利用して確率を計算する <br> Draw a probability tree and obtain probability from it

- ベイズの定理を実際に臨床的な疑問に応用する <br> Apply Bayes' Theorem to clinical examples



---
class: middle
# 確率 <br> probability

- 確率とは？<br> What is probability?

    - コインを投げて，表が出る確率は0.5 <br> when tossing a coin the probability of obtaining a head is 0.5
    - 明日長久手市で雨が降る確率は0.8 <br> The probability that it will rain tomorrow in Nagakute is 0.8

- 確率の正式な定義 <br> Formally define the probability: 

$$
P(\text{event of interest}) = \lim_{n \rightarrow \infty}\frac{n \text{ of events}}{\text{sum of  }n}
$$


---
class: middle
# 医学での確率 <br> probability in medicine

- 極めて重要な概念である <br> probability is crucial to medical science

    - イベントの予測 <br> predicting events
        - Aさん（50歳，男性，心血管疾患病歴なし，運動不足，脳卒中家族歴あり，糖尿病）のこれから１０年の間心臓病で死亡する確率？<br> What is the probability that a particular patient A will die from heart disease in the next 10 years?
    - 変数と変数との関係性を評価する <br> assessing whether two characterisitcs are related 
        - ピロリ菌感染と胃がん発生との関係 <br> Is _H. pylori_ infection related with the development of gastric cancer?

---
class: middle
# 実例 Example

- 臨床疑問：ピロリ菌の感染者，と非感染者の中に，胃がんの有病率はそれぞれどれぐらいあるでしょうか？ <br> What is the prevalence of gastric cancer patients in people infected with _H. pylori_, and in those who are _H. pylori_ free?

- 研究デザイン：集団から無作為的にサンプルを選んで来て，そのサンプルの中で，胃がん患者 $(A)$（ではない $(\bar{A})$）人数，それからピロリ菌の感染者 $(S)$（そうではない $(\bar{S})$）の人数をカウントする．<br> Randomly select a number of individuals from the population and record whether they have gastric cancer $(A)$ or not $(\bar{A})$, whether or not they were infected with _H. pylori_ ( $S$ or $\bar{S}$).

- （神様しか知らない）真の値：ある集団のピロリ菌感染率は70%，そのうち15%の感染者が胃がん患者で，非感染の残りの30%の人では，胃がんの患者の割合はわずかの3%．<br> True prevalence of _H. pylori_ in the population is 70% and that 15% of which suffer gastric cancer, whereas only 3% of people who are _H. pylori_ free have gatric cancer. 

---
class: middle
# 確率論の公理 <br> axioms of probability

1. $0 \leqslant P(A) \leqslant 1$ for any event $A$; 

2. $P(\Omega) = 1$ where $\Omega$ is the total sample space (全標本空間); 

3. For mutually exclusive events (排反事象) $A_1, \dots, A_n$:  $$P(A_1 \cup A_2 \cup \dots \cup A_n) = P(A_1) + P(A_2) +\cdots + P(A_n)$$



???

排反事象: はいはんじしょう

---
class: middle
# 条件付き確率 <br> conditional probability

胃がん患者 $(A)$，とピロリ菌感染者 $(S)$ の２つのイベントを考えてください：

- もしAさんがピロリ菌感染している，Aさんの胃がんである確率はどれぐらい？<br> Suppose we know that an individual is infected with _H. pylori_. What, then, is the probability that they suffer from asthma?

- これは条件付き確率と呼ばれる，つまり，感染していることが前提で，そのうち胃がんの割合． <br> we call this conditional probability of A "given" B.

- 条件付き確率の記載法: $P(A|S)$ <br> the probability that $A$ occurs, given or conditional on $S$ occuring.

条件付き確率もとても重要な概念である，例えば，以下の質問は典型的な条件付き質問：
高血圧の患者Aさん, これから5年間の間，心筋梗塞に罹患する確率．

---
class: middle
# 条件付き確率定義 <br> Defining conditional probability 

$$P(A|S) = \frac{P(A\cap S)}{P(S)}$$



$$
\Rightarrow  P(A\cap S) = P(S)P(A|S)
$$


---
class: middle, inverse
# 確率ツリー <br> Probability trees


---
class: middle

#### 成人での喫煙者の割合は20% <br> Prevalence of smoking is 20% among adults, i.e. $P(S) = 0.2$

#### 喫煙者の9%，非喫煙者の7%は喘息を罹っている <br> 9% of smokers and 7% of non-smokers have asthma, i.e. $P(A|S)= 0.09, P(A|\bar{S})  = 0.007$

#### Aさんは喫煙者かつ喘息患者の確率を求めよ <br> What is the probability that someone has asthma and is a smoker $P(A\cap S) =?$

---
class: middle
background-image: url("./pic/probability_tree.png")
background-position: 50% 50%
background-size: contain


---
class: middle, bottom
background-image: url("./pic/probability_tree.png")
background-position: 50% 50%
background-size: contain

$$
P(A\cap S) = p(S)\times P(A|S) = 0.018
$$


---
class: middle
# 逆条件 <br> Reverse conditioning

我々は逆条件を利用したくて，確率を出したい場合が多い <br> We often wish to reverse the conditioning in probabilities:

例えば，胃がん治療専門クリニックでは，どれぐらいの医療資源をピロリ菌除菌治療に投入すべきかを知りたい．<br> For example, suppose an gastric cancer clinic wants to know how many resources to dedicate to anti-_H. pylori_ treatment.

- 専門医は，胃がん患者の中に，_H. pylori_ 感染者の割合を算出したい．<br> The clinic would want to know what proportion of gastric cancer patients were actually infected with _H. pylori_, i.e. $P(S|A) = ?$.

- しかし，条件付きの確率だけわかる <br> we only have information about $P(A|S)$

---
class: middle
# ベイズの定理 I <br> Bayes theorem I

- We can express $P(A\cap S)$ in two ways: 

$$
\begin{aligned}
P(A\cap S) & = P(A|S)P(S) \\
& \text{or} \\ 
P(A\cap S) & = P(S|A)P(A)
\end{aligned}
$$

- Equating the two, we have: 

$$
\begin{aligned}
\Rightarrow P(S|A)P(A) & = P(A|S)P(S) \\
P(S|A) & = \frac{P(A|S)P(S)}{P(A)}
\end{aligned}
$$

---
class: middle
# ベイズの定理 II <br> Bayes theorem II

- Because 

$$
\begin{aligned}
P(A) & = P(A\cap S) + P(A \cap \bar{S}) \\
     & = P(A|S)P(S) + P(A|\bar{S})P(\bar{S})
\end{aligned}
$$


- So, we have: 

$$
\begin{aligned}
P(S|A) = \frac{P(A|S)P(S)}{P(A|S)P(S) + P(A|\bar{S})P(\bar{S})}
\end{aligned}
$$

これは**ベイズの定理**．<br> This is Bayes' Theorem


---
class: middle
## ベイズの定理の応用 <br> Apply Bayes' Theorem 


---
class: middle, bottom
background-image: url("./pic/probability_tree.png")
background-position: 50% 50%
background-size: contain

ある喘息患者が来院して，医師のあなたはベイズの定理を応用し，この患者が喫煙者である確率を求めてみた．

---
class: middle, bottom
background-image: url("./pic/probability_tree.png")
background-position: 50% 50%
background-size: contain

$$P(S|A) = \frac{P(A|S)P(S)}{P(A|S)P(S) + P(A|\bar{S})P(\bar{S})} = \frac{0.09\times0.2}{0.09\times0.2 + 0.07\times0.8} = 0.2432$$


---
class: middle
### 嚢胞性線維症(CF)スクリーニングテスト

- CFは遺伝子変異を原因とする劣性遺伝性疾患です．<br> Cystic fibrosis is an inherited disease

- 汗中クロライド濃度テストは診断に使うゴールドスタンダード．<br> The sweat chloride test is the gold standard diagnostic test. 

- 低所得国においては，簡易な測定方法がより適宜かもしれない．<br> In low income settings the simpler sweat conductivity test may be more appropriate. 

簡易測定法の属性：

- CF患者では，陽性結果になる確率は $P(+ve | CF) = 0.875$
- 言い換えれば，この測定法の**感度(sensitivity)**は $0.875$

- CF患者じゃない人で，陽性結果が出る確率は $P(+ve|\bar{CF}) = 0.004$
- つまり，**特異度(specificity)**は $P(-ve|\bar{CF}) = 1-0.004 = 0.996$


???

嚢胞性線維症のうほうせいせんいしょう

---
class: middle

# スクリーニングテスト <br> Screen test

実際普段臨床の場で，我らが最も知りたいのは，ある患者がスクリーンテスト陽性の結果 $P(+ve)$ を持って外来に来る時に，**この患者が本当に嚢胞性線維症(CF)を罹っている確率 $P(CF|+ve)$．**

<br>

The question we really want to answer is: "if a patient has a positive sweat conductivity test $P(+ve)$, **what is the probability that the patient has CF $P(CF|+ve)$?**"

つまり，**陽性的中率，positive predictive value (PPV), $P(CF|+ve)$**

---
class: middle, center

## ベイズの定理をこの例に適用してみよ

仮に，この集団ではCFの有病率は $P(CF) = 0.035$<br> Say the probability of CF in the population is $P(CF) = 0.035$.

$$
\begin{aligned}
P(+ve|CF) & = 0.875 \\ 
    P(CF) & = 0.0325 \\
P(+ve|\bar{CF}) & = 0.004 \\
\end{aligned}
$$
<br><br>
$$
P(CF|+ce) = ?
$$



---
class: middle, center

## ベイズの定理をこの例に適用してみよ

仮に，この集団ではCFの有病率は $P(CF) = 0.035$．<br> Say the probability of CF in the population is $P(CF) = 0.035$.

$$
\begin{aligned}
P(+ve|CF) & = 0.875 \\ 
    P(CF) & = 0.0325 \\
P(+ve|\bar{CF}) & = 0.004 \\
\end{aligned}
$$

**陽性的中率，Positive Predicitve Value, PPV, $P(CF|+ve)$ **


$$
\begin{aligned}
P(CF|+ve) & = \frac{P(+ve|CF)P(CF)}{P(+ve|CF)P(CF) + P(+ve|\bar{CF})P(\bar{CF})} \\ 
          & = \frac{0.875\times0.0325}{0.875\times0.0325 + 0.004\times(1-0.0325)} \\
          & = 0.88
\end{aligned}
$$


---
class: middle

- この集団ではCFの有病率は $P(CF) = 0.035$ <br> $\Rightarrow$ テスト行う**前**の確率のため，**事前確率(prior probability)**とも呼ばれる．

- 陽性的中率，Positive Predicitve Value, PPV, $P(CF|+ve) = 0.88$ <br> $\Rightarrow$ はテストを行う**後**の確率のため，**事後確率(posterior probability)**とも呼ばれる．

- つまり，スクリーニングテストを行った後，この患者がCFである確率が，テストを行った前の0.035から，0.88に更新された．


---
class: middle

# 質問&宿題 <br> Question & Homework

例えば，某集団でのHIVの感染率は事前の調査の結果，0.001と推定される．例えばあるスクリーニング検査法の感度(sensitivity)と特異度(specificity)はそれぞれ0.99, 0.98で検査法を開発した製薬メーカーさんから提供された．例えば患者Bさんがこの検査法で陽性の結果が得られた，Bさんが本当にHIVを感染している確率を算出せよ．この結果についてコメントしよ．

